<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£€æµ‹æ¨¡å—æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #28a745;
        }

        .btn-secondary:hover {
            background: #218838;
        }

        .path-display {
            background: #e9ecef;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 13px;
            color: #495057;
            word-break: break-all;
        }

        .result-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .result-content {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .info-box p {
            margin: 5px 0;
            color: #1976D2;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ£€æµ‹æ¨¡å—æµ‹è¯•é¡µé¢</h1>
        <p class="subtitle">æµ‹è¯•Detectæ¨¡å—å’ŒBarcodeæ¨¡å—çš„åŠŸèƒ½</p>

        <!-- å‚æ•°è®¾ç½® -->
        <div class="section">
            <h2 class="section-title">å‚æ•°è®¾ç½®</h2>
            <div class="info-box">
                <p><strong>è·¯å¾„è§„åˆ™ï¼š</strong>ä»»åŠ¡å·/åº“ä½å·/3d_camera/</p>
                <p>ç³»ç»Ÿä¼šè‡ªåŠ¨æ‹¼æ¥è·¯å¾„å¹¶ä¼ é€’ç»™æ£€æµ‹æ¨¡å—å’Œæ¡ç è¯†åˆ«æ¨¡å—</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>ä»»åŠ¡å· (taskNo) *</label>
                    <input type="text" id="taskNo" value="demo" placeholder="è¯·è¾“å…¥ä»»åŠ¡å·" required>
                </div>
                <div class="form-group">
                    <label>åº“ä½å· (binLocation) *</label>
                    <input type="text" id="binLocation" value="test01" placeholder="è¯·è¾“å…¥åº“ä½å·" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å †å›ID (pile_id) - ç”¨äºDetectæ¨¡å—</label>
                    <input type="number" id="pileId" value="1" min="1" placeholder="é»˜è®¤: 1">
                </div>
                <div class="form-group">
                    <label>æ¡ç ç±»å‹ (code_type) - ç”¨äºBarcodeæ¨¡å—</label>
                    <select id="codeType">
                        <option value="ucc128" selected>UCC128</option>
                        <option value="code128">Code128</option>
                        <option value="ean13">EAN13</option>
                    </select>
                </div>
            </div>

            <div class="path-display">
                <strong>æ‹¼æ¥åçš„è·¯å¾„ï¼š</strong>
                <span id="pathDisplay">demo/test01/3d_camera/</span>
                <br>
                <small style="color: #999;">(å®é™…è·¯å¾„: <span id="actualPath">capture_img/demo/test01/3d_camera/</span>)</small>
            </div>

            <button class="btn" onclick="runScanAndRecognize()">ğŸš€ è¿è¡Œæ‰«ç +è¯†åˆ«</button>
            <button class="btn btn-secondary" onclick="readRecognitionResult()">ğŸ“– è¯»å–è¯†åˆ«ç»“æœ</button>
        </div>

        <!-- Detectæ¨¡å—ç»“æœ -->
        <div class="section">
            <h2 class="section-title">Detectæ¨¡å—ç»“æœ</h2>
            <div id="detectResult" class="loading">ç­‰å¾…æ‰§è¡Œ...</div>
        </div>

        <!-- Barcodeæ¨¡å—ç»“æœ -->
        <div class="section">
            <h2 class="section-title">Barcodeæ¨¡å—ç»“æœ</h2>
            <div id="barcodeResult" class="loading">ç­‰å¾…æ‰§è¡Œ...</div>
        </div>
    </div>

    <script>
        // é»˜è®¤ä½¿ç”¨gatewayæœåŠ¡åœ°å€ï¼Œå¦‚æœå½“å‰é¡µé¢ä¸åœ¨gatewayä¸Šï¼Œåˆ™ä½¿ç”¨é…ç½®çš„åœ°å€
        const GATEWAY_URL = window.location.origin.includes('8000') 
            ? window.location.origin 
            : (localStorage.getItem('gateway_url') || 'http://localhost:8000');
        const API_BASE = GATEWAY_URL;
        
        // å¦‚æœAPI_BASEå’Œå½“å‰é¡µé¢ä¸åœ¨åŒä¸€åŸŸåï¼Œæ˜¾ç¤ºæç¤º
        if (API_BASE !== window.location.origin) {
            console.log(`ä½¿ç”¨Gateway APIåœ°å€: ${API_BASE}`);
        }

        // æ›´æ–°è·¯å¾„æ˜¾ç¤º
        function updatePathDisplay() {
            const taskNo = document.getElementById('taskNo').value || 'demo';
            const binLocation = document.getElementById('binLocation').value || 'test01';
            const path = `${taskNo}/${binLocation}/3d_camera/`;
            const actualPath = `capture_img/${path}`;
            
            const pathDisplay = document.getElementById('pathDisplay');
            const actualPathDisplay = document.getElementById('actualPath');
            
            if (pathDisplay) {
                pathDisplay.innerHTML = path;
            }
            if (actualPathDisplay) {
                actualPathDisplay.innerHTML = actualPath;
            }
        }

        // è·å–æ‹¼æ¥åçš„è·¯å¾„
        function getImagePath() {
            const taskNo = document.getElementById('taskNo').value.trim();
            const binLocation = document.getElementById('binLocation').value.trim();
            
            if (!taskNo || !binLocation) {
                alert('è¯·å¡«å†™ä»»åŠ¡å·å’Œåº“ä½å·');
                return null;
            }
            
            return `${taskNo}/${binLocation}/3d_camera/`;
        }

        // è¿è¡Œæ‰«ç +è¯†åˆ«ï¼ˆæ­£å¼çš„gatewayæ¥å£ï¼‰
        async function runScanAndRecognize() {
            const taskNo = document.getElementById('taskNo').value.trim();
            const binLocation = document.getElementById('binLocation').value.trim();
            
            if (!taskNo || !binLocation) {
                alert('è¯·å¡«å†™ä»»åŠ¡å·å’Œåº“ä½å·');
                return;
            }

            const pileId = parseInt(document.getElementById('pileId').value) || 1;
            const codeType = document.getElementById('codeType').value;
            const detectResultDiv = document.getElementById('detectResult');
            const barcodeResultDiv = document.getElementById('barcodeResult');
            
            detectResultDiv.innerHTML = '<div class="loading">æ­£åœ¨è¿è¡Œæ‰«ç +è¯†åˆ«...</div>';
            barcodeResultDiv.innerHTML = '<div class="loading">ç­‰å¾…ç»“æœ...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/inventory/scan-and-recognize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        taskNo: taskNo,
                        binLocation: binLocation,
                        pile_id: pileId,
                        code_type: codeType
                    })
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    // æ˜¾ç¤ºDetectç»“æœ
                    if (result.data.detect_result) {
                        if (result.data.detect_result.status === 'success') {
                            detectResultDiv.innerHTML = `
                                <div class="success">
                                    <div class="result-title">âœ… Detectæ¨¡å—æ‰§è¡ŒæˆåŠŸ</div>
                                    <div class="result-content">${JSON.stringify(result.data.detect_result, null, 2)}</div>
                                </div>
                            `;
                        } else {
                            detectResultDiv.innerHTML = `
                                <div class="error">
                                    <div class="result-title">âŒ Detectæ¨¡å—æ‰§è¡Œå¤±è´¥</div>
                                    <div class="result-content">${JSON.stringify(result.data.detect_result, null, 2)}</div>
                                </div>
                            `;
                        }
                    }
                    
                    // æ˜¾ç¤ºBarcodeç»“æœ
                    if (result.data.barcode_result) {
                        if (result.data.barcode_result.status === 'success') {
                            barcodeResultDiv.innerHTML = `
                                <div class="success">
                                    <div class="result-title">âœ… Barcodeæ¨¡å—æ‰§è¡ŒæˆåŠŸ</div>
                                    <div class="result-content">${JSON.stringify(result.data.barcode_result, null, 2)}</div>
                                </div>
                            `;
                        } else {
                            barcodeResultDiv.innerHTML = `
                                <div class="error">
                                    <div class="result-title">âŒ Barcodeæ¨¡å—æ‰§è¡Œå¤±è´¥</div>
                                    <div class="result-content">${JSON.stringify(result.data.barcode_result, null, 2)}</div>
                                </div>
                            `;
                        }
                    }
                } else {
                    detectResultDiv.innerHTML = `
                        <div class="error">
                            <div class="result-title">âŒ æ‰«ç +è¯†åˆ«æ‰§è¡Œå¤±è´¥</div>
                            <div class="result-content">${result.message || result.detail || 'æœªçŸ¥é”™è¯¯'}</div>
                        </div>
                    `;
                    barcodeResultDiv.innerHTML = '<div class="loading">ç­‰å¾…æ‰§è¡Œ...</div>';
                }
            } catch (error) {
                let errorMessage = error.message;
                let errorDetails = '';
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    errorDetails = `
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                            <strong>è¯Šæ–­ä¿¡æ¯ï¼š</strong><br>
                            â€¢ APIåœ°å€: ${API_BASE}/api/inventory/scan-and-recognize<br>
                            â€¢ å½“å‰é¡µé¢: ${window.location.origin}<br>
                            â€¢ å¯èƒ½çš„åŸå› ï¼š<br>
                            &nbsp;&nbsp;1. GatewayæœåŠ¡æœªå¯åŠ¨ï¼ˆè¯·æ£€æŸ¥ http://localhost:8000 æ˜¯å¦å¯è®¿é—®ï¼‰<br>
                            &nbsp;&nbsp;2. CORSé…ç½®é—®é¢˜ï¼ˆå¦‚æœé¡µé¢ç«¯å£ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼‰<br>
                            &nbsp;&nbsp;3. ç½‘ç»œè¿æ¥é—®é¢˜<br>
                            <br>
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            â€¢ ç¡®ä¿GatewayæœåŠ¡æ­£åœ¨è¿è¡Œ: <code>python services/api/gateway.py</code> æˆ–è¿è¡Œå¯åŠ¨è„šæœ¬<br>
                            â€¢ å¦‚æœä½¿ç”¨file://æ‰“å¼€æ­¤é¡µé¢ï¼Œè¯·é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®ï¼ˆå¦‚ http://localhost:8000/static/test_detect.htmlï¼‰
                        </div>
                    `;
                }
                
                detectResultDiv.innerHTML = `
                    <div class="error">
                        <div class="result-title">âŒ è¯·æ±‚å¤±è´¥</div>
                        <div class="result-content">${errorMessage}${errorDetails}</div>
                    </div>
                `;
                barcodeResultDiv.innerHTML = '<div class="loading">ç­‰å¾…æ‰§è¡Œ...</div>';
            }
        }

        // è¯»å–è¯†åˆ«ç»“æœï¼ˆæ­£å¼çš„gatewayæ¥å£ï¼‰
        async function readRecognitionResult() {
            const taskNo = document.getElementById('taskNo').value.trim();
            const binLocation = document.getElementById('binLocation').value.trim();
            
            if (!taskNo || !binLocation) {
                alert('è¯·å¡«å†™ä»»åŠ¡å·å’Œåº“ä½å·');
                return;
            }

            const detectResultDiv = document.getElementById('detectResult');
            const barcodeResultDiv = document.getElementById('barcodeResult');
            
            detectResultDiv.innerHTML = '<div class="loading">æ­£åœ¨è¯»å–è¯†åˆ«ç»“æœ...</div>';
            barcodeResultDiv.innerHTML = '<div class="loading">ç­‰å¾…ç»“æœ...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/inventory/recognition-result?taskNo=${encodeURIComponent(taskNo)}&binLocation=${encodeURIComponent(binLocation)}`);

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    // æ˜¾ç¤ºDetectç»“æœ
                    if (result.data.detect_result) {
                        detectResultDiv.innerHTML = `
                            <div class="success">
                                <div class="result-title">âœ… Detectè¯†åˆ«ç»“æœ</div>
                                <div class="result-content">${JSON.stringify(result.data.detect_result, null, 2)}</div>
                            </div>
                        `;
                    } else {
                        detectResultDiv.innerHTML = '<div class="loading">æš‚æ— Detectç»“æœ</div>';
                    }
                    
                    // æ˜¾ç¤ºBarcodeç»“æœ
                    if (result.data.barcode_result) {
                        barcodeResultDiv.innerHTML = `
                            <div class="success">
                                <div class="result-title">âœ… Barcodeè¯†åˆ«ç»“æœ</div>
                                <div class="result-content">${JSON.stringify(result.data.barcode_result, null, 2)}</div>
                            </div>
                        `;
                    } else {
                        barcodeResultDiv.innerHTML = '<div class="loading">æš‚æ— Barcodeç»“æœ</div>';
                    }
                } else {
                    detectResultDiv.innerHTML = `
                        <div class="error">
                            <div class="result-title">âŒ è¯»å–è¯†åˆ«ç»“æœå¤±è´¥</div>
                            <div class="result-content">${result.message || result.detail || 'æœªçŸ¥é”™è¯¯'}</div>
                        </div>
                    `;
                    barcodeResultDiv.innerHTML = '<div class="loading">ç­‰å¾…æ‰§è¡Œ...</div>';
                }
            } catch (error) {
                let errorMessage = error.message;
                let errorDetails = '';
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    errorDetails = `
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                            <strong>è¯Šæ–­ä¿¡æ¯ï¼š</strong><br>
                            â€¢ APIåœ°å€: ${API_BASE}/api/inventory/recognition-result<br>
                            â€¢ å½“å‰é¡µé¢: ${window.location.origin}<br>
                            â€¢ å¯èƒ½çš„åŸå› ï¼š<br>
                            &nbsp;&nbsp;1. GatewayæœåŠ¡æœªå¯åŠ¨ï¼ˆè¯·æ£€æŸ¥ http://localhost:8000 æ˜¯å¦å¯è®¿é—®ï¼‰<br>
                            &nbsp;&nbsp;2. CORSé…ç½®é—®é¢˜ï¼ˆå¦‚æœé¡µé¢ç«¯å£ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼‰<br>
                            &nbsp;&nbsp;3. ç½‘ç»œè¿æ¥é—®é¢˜<br>
                            <br>
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            â€¢ ç¡®ä¿GatewayæœåŠ¡æ­£åœ¨è¿è¡Œ: <code>python services/api/gateway.py</code> æˆ–è¿è¡Œå¯åŠ¨è„šæœ¬<br>
                            â€¢ å¦‚æœä½¿ç”¨file://æ‰“å¼€æ­¤é¡µé¢ï¼Œè¯·é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®ï¼ˆå¦‚ http://localhost:8000/static/test_detect.htmlï¼‰
                        </div>
                    `;
                }
                
                detectResultDiv.innerHTML = `
                    <div class="error">
                        <div class="result-title">âŒ è¯·æ±‚å¤±è´¥</div>
                        <div class="result-content">${errorMessage}${errorDetails}</div>
                    </div>
                `;
                barcodeResultDiv.innerHTML = '<div class="loading">ç­‰å¾…æ‰§è¡Œ...</div>';
            }
        }

        // å…¼å®¹æ—§æ¥å£åç§°
        async function runDetect() {
            await runScanAndRecognize();
        }

        async function runBarcode() {
            await runScanAndRecognize();
        }

        async function runBoth() {
            await runScanAndRecognize();
        }

        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œæ›´æ–°è·¯å¾„æ˜¾ç¤º
        document.getElementById('taskNo').addEventListener('input', updatePathDisplay);
        document.getElementById('binLocation').addEventListener('input', updatePathDisplay);

        // æ£€æŸ¥GatewayæœåŠ¡æ˜¯å¦å¯ç”¨
        async function checkGatewayConnection() {
            try {
                // å°è¯•è®¿é—®docsç«¯ç‚¹ï¼ˆæ›´å¯é ï¼‰
                const response = await fetch(`${API_BASE}/docs`, { 
                    method: 'HEAD',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                if (response.ok || response.status === 405) {  // 405 Method Not Allowedä¹Ÿæ˜¯æ­£å¸¸çš„ï¼ˆè¡¨ç¤ºæœåŠ¡å­˜åœ¨ï¼‰
                    console.log('âœ… GatewayæœåŠ¡è¿æ¥æ­£å¸¸');
                    return true;
                }
            } catch (error) {
                console.warn('âš ï¸ GatewayæœåŠ¡è¿æ¥å¤±è´¥:', error.message);
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºè­¦å‘Šï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºï¼‰
                const container = document.querySelector('.container');
                if (container && !document.getElementById('gateway-warning')) {
                    const warning = document.createElement('div');
                    warning.id = 'gateway-warning';
                    warning.className = 'info-box';
                    warning.style.background = '#fff3cd';
                    warning.style.borderLeftColor = '#ffc107';
                    warning.style.marginBottom = '20px';
                    warning.innerHTML = `
                        <p><strong>âš ï¸ è­¦å‘Šï¼šæ— æ³•è¿æ¥åˆ°GatewayæœåŠ¡</strong></p>
                        <p>APIåœ°å€: <code>${API_BASE}</code></p>
                        <p>è¯·ç¡®ä¿GatewayæœåŠ¡æ­£åœ¨è¿è¡Œã€‚å¦‚æœæœåŠ¡åœ¨å…¶ä»–åœ°å€ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚</p>
                        <p style="margin-top: 10px;">
                            <strong>è§£å†³æ–¹æ³•ï¼š</strong><br>
                            1. è¿è¡Œå¯åŠ¨è„šæœ¬: <code>cd demo && ./start_gateway_test.sh</code><br>
                            2. æˆ–æ‰‹åŠ¨å¯åŠ¨: <code>python services/api/gateway.py</code><br>
                            3. å¦‚æœGatewayåœ¨å…¶ä»–åœ°å€ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°è®¾ç½®: <code>localStorage.setItem('gateway_url', 'http://your-gateway-url:port')</code>
                        </p>
                        <button onclick="checkGatewayConnection()" style="margin-top: 10px; padding: 5px 10px; background: #ffc107; border: none; border-radius: 4px; cursor: pointer;">ğŸ”„ é‡æ–°æ£€æŸ¥è¿æ¥</button>
                    `;
                    container.insertBefore(warning, container.firstChild.nextSibling);
                }
                return false;
            }
            return false;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è·¯å¾„æ˜¾ç¤ºå’Œæ£€æŸ¥è¿æ¥
        window.addEventListener('DOMContentLoaded', () => {
            updatePathDisplay();
            checkGatewayConnection();
        });
    </script>
</body>
</html>



