# Integration ç›®å½•è¿è¡ŒæŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªçƒŸè‰ä»“å‚¨ç›˜ç‚¹ç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š
- **åç«¯ç½‘å…³**ï¼šFastAPI æœåŠ¡ï¼Œä½œä¸ºå‰åç«¯å’Œå¤–éƒ¨ç³»ç»Ÿçš„ä¸­é—´å±‚
- **å‰ç«¯ç•Œé¢**ï¼šReact + TypeScript æ„å»ºçš„ç®¡ç†ç•Œé¢
- **å›¾åƒå¤„ç†**ï¼šYOLO ç›®æ ‡æ£€æµ‹ + æ¡å½¢ç è¯†åˆ«
- **æ¨¡æ‹ŸæœåŠ¡**ï¼šç”¨äºå¼€å‘å’Œæµ‹è¯•çš„ LMS/RCS æ¨¡æ‹ŸæœåŠ¡

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ UI    â”‚  (React, ç«¯å£ 3000)
â”‚  (React)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTPè¯·æ±‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘å…³æœåŠ¡   â”‚  (FastAPI, ç«¯å£ 8000)
â”‚  (Gateway)  â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚      â”‚
   â†“      â†“
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ LMS â”‚ â”‚ RCS â”‚  (æ¨¡æ‹ŸæœåŠ¡: 6000, 4001)
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ è¿è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡

1. **åˆ›å»ºå¹¶æ¿€æ´» Conda ç¯å¢ƒ**
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
conda env create -f environment.yml
conda activate tobacco_env
```

2. **å®‰è£… Python ä¾èµ–**
```bash
# è¿›å…¥ Integration/app ç›®å½•
cd Intergration/app

# å®‰è£… FastAPI ç›¸å…³ä¾èµ–
pip install fastapi uvicorn requests python-multipart
```

3. **å®‰è£…å‰ç«¯ä¾èµ–**
```bash
# è¿›å…¥ UI ç›®å½•
cd ../ui

# å®‰è£… Node.js ä¾èµ–ï¼ˆä½¿ç”¨ pnpmï¼‰
pnpm install
# å¦‚æœæ²¡æœ‰ pnpmï¼Œå…ˆå®‰è£…ï¼šnpm install -g pnpm
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨åç«¯æœåŠ¡

**éœ€è¦æŒ‰é¡ºåºå¯åŠ¨ä»¥ä¸‹æœåŠ¡ï¼š**

#### 1. å¯åŠ¨ LMS æ¨¡æ‹ŸæœåŠ¡ï¼ˆç«¯å£ 6000ï¼‰

```bash
cd Intergration/app/sim/lms
conda activate tobacco_env
bash start_sim_lms_server.sh
# æˆ–è€…ç›´æ¥è¿è¡Œï¼š
# uvicorn sim_lms_server:app --host 0.0.0.0 --port 6000 --reload
```

**éªŒè¯**ï¼šè®¿é—® http://localhost:6000/docs æŸ¥çœ‹ API æ–‡æ¡£

#### 2. å¯åŠ¨ç½‘å…³æœåŠ¡ï¼ˆç«¯å£ 8000ï¼‰

```bash
cd Intergration/app
conda activate tobacco_env
bash start_gateway.sh
# æˆ–è€…ç›´æ¥è¿è¡Œï¼š
# uvicorn gateway:app --host 0.0.0.0 --port 8000 --reload
```

**éªŒè¯**ï¼šè®¿é—® http://localhost:8000/docs æŸ¥çœ‹ API æ–‡æ¡£

#### 3. ï¼ˆå¯é€‰ï¼‰å¯åŠ¨ RCS æ¨¡æ‹ŸæœåŠ¡ï¼ˆç«¯å£ 4001ï¼‰

å¦‚æœéœ€è¦æµ‹è¯• RCS åŠŸèƒ½ï¼š
```bash
cd Intergration/app/sim/rcs
conda activate tobacco_env
bash start_sim_rcs_server.sh
```

### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd Intergration/ui
pnpm run dev
# æˆ–è€…ä½¿ç”¨ npmï¼š
# npm run dev
```

**éªŒè¯**ï¼šè®¿é—® http://localhost:3000

## ğŸ“ é»˜è®¤ç™»å½•ä¿¡æ¯

æ ¹æ® `sim_lms_server.py` çš„é…ç½®ï¼š
- **ç”¨æˆ·å**ï¼š`admin`
- **å¯†ç **ï¼š`admin`

## ğŸ” æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### åç«¯æ–‡ä»¶

1. **`app/gateway.py`** - ä¸»ç½‘å…³æœåŠ¡
   - `/login` - ç”¨æˆ·ç™»å½•
   - `/auth/token` - Token éªŒè¯
   - `/lms/getLmsBin` - è·å–åº“ä½ä¿¡æ¯
   - `/lms/getCountTasks` - è·å–ç›˜ç‚¹ä»»åŠ¡
   - `/lms/setTaskResults` - æäº¤ç›˜ç‚¹ç»“æœ
   - `/rcs/controller/task/group` - RCS ä»»åŠ¡ç»„ç®¡ç†

2. **`app/custom_utils.py`** - å·¥å…·å‡½æ•°
   - `compress_and_encode()` - æ•°æ®å‹ç¼©ç¼–ç ï¼ˆzlib + base64ï¼‰
   - `decompress_and_decode()` - æ•°æ®è§£å‹ç¼©è§£ç 

3. **`app/yolo_detection.py`** - YOLO ç›®æ ‡æ£€æµ‹
   - æ£€æµ‹ç±»åˆ«ï¼šæ¡å½¢ç ã€äºŒç»´ç ã€å †å›ã€ç®±å­
   - è¾“å‡ºï¼šæ£€æµ‹ç»“æœ JSON + è£å‰ªå›¾ç‰‡

4. **`app/barcode_recognizer.py`** - æ¡å½¢ç è¯†åˆ«
   - ä½¿ç”¨ BarcodeReaderCLI å·¥å…·è¯†åˆ«æ¡å½¢ç 
   - æ”¯æŒ UCC128ã€Code128ã€EAN13 ç­‰æ ¼å¼

### å‰ç«¯æ–‡ä»¶

1. **`ui/src/App.tsx`** - ä¸»åº”ç”¨è·¯ç”±
   - `/` - é¦–é¡µï¼ˆç™»å½•é¡µï¼‰
   - `/dashboard` - ä»ªè¡¨ç›˜
   - `/inventory/start` - ç›˜ç‚¹å¯åŠ¨
   - `/inventory/progress` - ç›˜ç‚¹è¿›åº¦

2. **`ui/src/config/ip_address.ts`** - API åœ°å€é…ç½®
   - é»˜è®¤ç½‘å…³åœ°å€ï¼š`http://localhost:8000`

### æ¨¡æ‹ŸæœåŠ¡

1. **`app/sim/lms/sim_lms_server.py`** - LMS æ¨¡æ‹ŸæœåŠ¡
   - æä¾›ç™»å½•ã€åº“ä½ã€ä»»åŠ¡ç­‰æ¥å£
   - è¿”å›å‹ç¼©ç¼–ç çš„æ•°æ®ï¼ˆæ¨¡æ‹ŸçœŸå® LMSï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8000  # ç½‘å…³ç«¯å£
lsof -i :6000  # LMSç«¯å£
lsof -i :3000  # å‰ç«¯ç«¯å£

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### 2. ä¾èµ–å®‰è£…å¤±è´¥
```bash
# Python ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt  # å¦‚æœæœ‰çš„è¯

# Node.js ä¾èµ–
rm -rf node_modules package-lock.json
pnpm install
```

### 3. CORS é”™è¯¯
æ£€æŸ¥ `gateway.py` ä¸­çš„ `origins` é…ç½®ï¼Œç¡®ä¿åŒ…å«å‰ç«¯åœ°å€ã€‚

### 4. å›¾åƒå¤„ç†æ¨¡å—æ— æ³•è¿è¡Œ
ç¡®ä¿ï¼š
- YOLO æ¨¡å‹æ–‡ä»¶å­˜åœ¨ï¼š`yolo_model_weight/best.pt`
- BarcodeReaderCLI å·¥å…·å¯æ‰§è¡Œï¼š`utils/BarcodeReaderCLI/bin/BarcodeReaderCLI`

## ğŸ“Š æ•°æ®æµè¯´æ˜

1. **ç™»å½•æµç¨‹**ï¼š
   ```
   å‰ç«¯ â†’ ç½‘å…³(/login) â†’ LMS(/login) â†’ è¿”å› token
   ```

2. **è·å–ä»»åŠ¡æµç¨‹**ï¼š
   ```
   å‰ç«¯ â†’ ç½‘å…³(/lms/getCountTasks) â†’ LMS â†’ è§£å‹ç¼©æ•°æ® â†’ è¿”å›å‰ç«¯
   ```

3. **æäº¤ç»“æœæµç¨‹**ï¼š
   ```
   å‰ç«¯ â†’ ç½‘å…³(/lms/setTaskResults) â†’ å‹ç¼©æ•°æ® â†’ LMS â†’ è¿”å›æˆåŠŸ
   ```

## ğŸ”§ å¼€å‘å»ºè®®

1. **ä½¿ç”¨æ¨¡æ‹ŸæœåŠ¡è¿›è¡Œå¼€å‘**ï¼šé¿å…ä¾èµ–çœŸå® LMS/RCS æœåŠ¡
2. **æŸ¥çœ‹ API æ–‡æ¡£**ï¼šè®¿é—® `http://localhost:8000/docs` å’Œ `http://localhost:6000/docs`
3. **æ£€æŸ¥æ—¥å¿—**ï¼šæ‰€æœ‰æœåŠ¡éƒ½ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
4. **æ•°æ®æ ¼å¼**ï¼šLMS æ¥å£ä½¿ç”¨å‹ç¼©ç¼–ç ï¼Œæ³¨æ„ä½¿ç”¨ `custom_utils` å¤„ç†

## ğŸ“¦ è¾“å‡ºç›®å½•

å¤„ç†ç»“æœä¿å­˜åœ¨ `Intergration/output/` ç›®å½•ä¸‹ï¼ŒæŒ‰æ—¶é—´æˆ³ç»„ç»‡ï¼š
```
output/
  â””â”€â”€ 20251020_223052/
      â”œâ”€â”€ barcode/          # æ¡å½¢ç è¯†åˆ«ç»“æœ
      â”œâ”€â”€ box/              # ç®±å­æ£€æµ‹ç»“æœ
      â”œâ”€â”€ piles/            # å †å›æ£€æµ‹ç»“æœ
      â””â”€â”€ detected_images/  # å¸¦æ£€æµ‹æ¡†çš„åŸå›¾
```

