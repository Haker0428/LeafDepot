# 约束
| 维度       | 分类                      | 典型示意             | 算法核心逻辑            |
| -------- | ----------------------- | ---------------- | ----------------- |
| **视角维度** | **A. 正视视角（Front View）** | 相机光轴垂直于烟箱面       | 以行列网格为基础推理        |
|          | **B. 俯视视角（Top View）**   | 相机高于烟箱一层，可看到堆叠深度 | 以平面投影与矩形聚类为基础推理   |
| **堆叠维度** | **1. 单层堆叠（1层）**         | 一层平铺             | 可见数量即真实数量         |
|          | **2. 多层堆叠（>1层）**        | 规则堆叠             | 需要遮挡补全逻辑          |
| **摆放规律** | **后→前堆叠**（固定）           | 非满垛时从后往前放        | 可作为约束条件避免“空洞”推测   |
| **计数目标** | **烟箱个数**                | 每个独立箱体           | 算法需兼顾遮挡、俯视重叠、边缘截断 |


# 垛堆表示
PileType（垛型）
 └── LayerPattern（单层摆放）
       └── BoxGrid（具体烟箱位置）

Pile = [Layer1, Layer2, Layer3, ...]

## 垛堆定义
| 字段                  | 类型        | 说明                         |
| ------------------- | --------- | -------------------------- |
| `pile_id`           | int       | 唯一垛堆ID                     |
| `name`              | str       | 垛堆名称（如“双层交错堆”）             |
| `layer_count`       | int       | 总层数                        |
| `layer_ids`         | list[int] | 对应每层的 pattern ID           |
| `pile_depth`        | float     | 垛堆深度（Z方向尺寸，用于投影计算）         |
| `pile_height`       | float     | 垛堆总高度（用于估算行数）              |
| `visible_direction` | str       | 可见方向（front / left / right） |



# 约束
* 一个照片只处理一个垛堆


# 满层判断逻辑

## 计算关键特征

### (1) 横向覆盖率 coverage (Horizontal Coverage Rate)

**定义：**

$$coverage = (箱体横向并集宽度) / (pile总宽度)$$

**特点：**
- 表示整层的填充率
- 连续填充 → coverage ≈ 1
- 缺箱或空洞 → coverage 明显下降

✓ **主判定指标**

### (2) 间距变异系数 cv_gap (Coefficient of Variation of Gap)

**定义：**

$$cv_gap = σ(g) / μ(g)$$

其中 $$g_i = center_{i+1} - center_i$$

**特点：**
- 衡量箱体之间的横向均匀性
- 若有漏箱或空隙 → 间距突变 → cv_gap 变大

### (3) 宽度变异系数 cv_width (仅提示)

**定义：**

$$cv_width = σ(w) / μ(w)$$

其中 $$w_i = x2_i - x1_i$$

**特点：**
- 表示箱体宽度一致性
- 用于检测异常（如横竖混放、识别误差）
- 不参与满层判定

▲ **仅日志输出，不影响结果**

## ④ 总数计算逻辑

**根据业务约束：**
- 若最高层满 → 整堆满
- 若最高层不满 → 仅计算下层模板 + 顶层实际检测数

**计算公式：**

$$total = \begin{cases}
    \sum_i template_i, & \text{if } full = True \\
    \sum_{i=1}^{N-1} template_i + O_{top}, & \text{if } full = False
\end{cases}$$

其中：
- $template_i$ 表示第 $i$ 层的模板数量
- $O_{top}$ 表示顶层实际检测到的箱体数量
- $full$ 表示顶层是否满层

